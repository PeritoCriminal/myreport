{% extends 'base.html' %}
{% block center_content %}
<div class="container mt-5 ml-5 mr-5">
    <h2 class="mb-4 text-center pl-4 pr-4">Dados do Atendimento</h2>
    <form method="post" class="mx-auto" style="max-width: 600px;" onsubmit="return checkInputs();">
        {% csrf_token %}
        <div class="form-group">
            <label for="expert_display_name">Perito:</label>
            <input type="text" id="expert_display_name" name="expert_display_name" required class="form-control custom-input" value="{{ expert_display_name }}">
        </div>
        <div class="form-group">
            <label for="institute_director">Diretor do Instituto de Criminalística:</label>
            <input type="text" id="institute_director" name="institute_director" required class="form-control custom-input" value="{{ institute_director }}">
        </div>
        <div class="form-group">
            <label for="institute_unit">Unidade:</label>
            <input type="text" id="institute_unit" name="institute_unit" required class="form-control custom-input" value="{{ institute_unit }}">
        </div>
        <div class="form-group">
            <label for="forensic_team_base">Equipe:</label>
            <input type="text" id="forensic_team_base" name="forensic_team_base" required class="form-control custom-input" value="{{ forensic_team_base }}">
        </div>
        <div class="form-group">
            <label for="report_number">Número do Laudo:</label>
            <input type="text" id="report_number" name="report_number" required class="form-control custom-input" value="{{ report_number }}">
        </div>
        <div class="form-group">
            <label for="protocol_number">Número do Protocolo:</label>
            <input type="text" id="protocol_number" name="protocol_number" required class="form-control custom-input" value="{{ protocol_number }}">
        </div>
        <div class="form-group">
            <label for="designation_date">Data de Designação:</label>
            <input type="date" id="designation_date" name="designation_date" class="form-control custom-input" value="{{  designation_date }}">
        </div>
        <div class="form-group">
            <label for="service_date">Data de Atendimento:</label>
            <input type="date" id="service_date" name="service_date" class="form-control custom-input" value="{{ service_date }}">
        </div>
        <div class="form-group">
            <label for="service_time">Horário do Atendimento:</label>
            <input type="time" id="service_time" name="service_time" class="form-control custom-input" value="{{ service_time }}">
        </div>
        <div class="form-group">
            <label for="photographer">Fotografia:</label>
            <input type="text" id="photographer" name="photographer" class="form-control custom-input" value="{{ report_photographer }}">
        </div>
        <div class="form-row">
            <div class="col">
                <button type="submit" id="submit_btn" class="btn btn-primary btn-block">
                    {% if post.id %}
                        Atualizar
                    {% else %}
                        Criar
                    {% endif %}
                </button>
            </div>
            <div class="col">
                <a href="{% url 'home' %}" class="btn btn-secondary btn-block">Cancelar</a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>

    document.querySelector('#report_number').focus();
    document.querySelector('#expert_display_name').addEventListener('change', (e) => {
        e.target.value = toNiceName(e.target.value);
    });
    document.querySelector('#institute_director').addEventListener('change', (e) => {
        e.target.value = toNiceName(e.target.value);
    });
    document.querySelector('#photographer').addEventListener('change', (e) => {
        e.target.value = toNiceName(e.target.value);
    });
    document.querySelector('#designation_date').addEventListener('blur', (e) => {
        const reportNumberElement = document.querySelector('#report_number');
        const protocoltNumberElement = document.querySelector('#protocol_number');
        const designationDateElement = document.querySelector('#designation_date');    
        reportNumberElement.value = adjustProtocol(reportNumberElement.value, designationDateElement.value);
        protocoltNumberElement.value = adjustProtocol(protocoltNumberElement.value, designationDateElement.value);
    });    

    function checkInputs() {
        const fields = [
            { id: 'expert_display_name', message: 'O nome do perito é obrigatório.' },
            { id: 'institute_director', message: 'O nome do diretor é obrigatório.' },
            { id: 'institute_unit', message: 'A unidade é obrigatória.' },
            { id: 'forensic_team_base', message: 'A equipe é obrigatória.' },
            { id: 'report_number', message: 'O número do laudo é obrigatório.' },
            { id: 'protocol_number', message: 'O número do protocolo é obrigatório.' },
            { id: 'designation_date', message: 'A data de designação é obrigatória.', type: 'date' },
            { id: 'service_date', message: 'A data de atendimento é obrigatória.', type: 'date' },
            { id: 'service_time', message: 'O horário de atendimento é obrigatório.', type: 'time' }
        ];

        for (let field of fields) {
            const element = document.getElementById(field.id);
            const value = element.value.trim();

            if (!value) {
                alert(field.message);
                element.focus();
                return false;
            }

            if (field.type === 'date' && !isValidDate(value)) {
                alert(`${field.message} Insira uma data válida no formato AAAA-MM-DD.`);
                element.focus();
                return false;
            }

            if (field.type === 'time' && !isValidTime(value)) {
                alert(`${field.message} Insira um horário válido no formato HH:MM.`);
                element.focus();
                return false;
            }
        }
        return true;
    }

    function isValidDate(value) {
        const regex = /^\d{4}-\d{2}-\d{2}$/;
        if (!regex.test(value)) return false;
        const date = new Date(value);
        return !isNaN(date.getTime());
    }

    function isValidTime(value) {
        const regex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        return regex.test(value);
    }
</script>
{% endblock scripts %}
