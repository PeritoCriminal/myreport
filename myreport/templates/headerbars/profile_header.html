{# myreport/templates/headerbars/profile_header.html #}

{% load static %}

{# Define 'owner' como o usuário passado ou o usuário logado #}
{% with owner=owner|default:user %}
  <div class="position-relative mb-5">
    {# Área de Background Image #}
    <div
        class="w-100 position-relative"
        style="
            height: 160px;
            background-image: url('{% if owner.background_image %}{{ owner.background_image.url }}{% else %}{% static 'myreport/img/backgroundimage.jpg' %}{% endif %}');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        "
    >
      {# Faixa de comandos sobreposta #}
      <div class="position-absolute start-0 end-0" style="bottom: 0;">
        <div class="px-3 py-2" style="background: rgba(0,0,0,.35);">
          <div class="d-flex justify-content-end gap-3 flex-wrap">
            {% if owner.id %}
              {# Navegação: Perfil #}
              <a href="{% url 'accounts:user_profile' owner.id %}?tab=profile"
                class="btn btn-sm d-flex align-items-center gap-2 shadow-sm
                                    {% if active_tab == 'profile' %}
                  btn-primary
                {% else %}
                  btn-light
                {% endif %}"
                title="Perfil"
                data-bs-toggle="tooltip"
                data-bs-placement="top">
                <i class="bi bi-person"></i>
                <span class="d-none d-md-inline">Perfil</span>
              </a>

              {# Navegação: Postagens #}
              <a href="{% url 'accounts:user_profile' owner.id %}?tab=posts"
                class="btn btn-sm d-flex align-items-center gap-2 shadow-sm
                                    {% if active_tab == 'posts' %}
                  btn-primary
                {% else %}
                  btn-light
                {% endif %}"
                title="Postagens"
                data-bs-toggle="tooltip"
                data-bs-placement="top">
                <i class="bi bi-grid-3x3-gap"></i>
                <span class="d-none d-md-inline">Postagens</span>
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    {# BLOCO DA IMAGEM E TEXTO DE PERFIL (POSICIONADO À ESQUERDA) #}
    <div class="position-absolute start-0 ms-3" style="bottom: -56px;">
      <div class="d-flex align-items-center gap-3">
        {# Imagem de Perfil #}
        {% if owner.profile_image %}
          <img src="{{ owner.profile_image.url }}" alt="Foto de perfil" class="rounded-circle border border-4 border-white bg-white shadow-sm" style="width:112px; height:112px; object-fit:cover;" />
        {% elif profile_image and profile_image.url %}
          <img src="{{ profile_image.url }}" alt="Foto de perfil" class="rounded-circle border border-4 border-white bg-white shadow-sm" style="width:112px; height:112px; object-fit:cover;" />
        {% endif %}

        {% if owner.id != user.id %}
          <div class="pt-5 mt-5 d-none d-md-block">
            <h4 class="fw-bold m-0 text-truncate">Página pessoal de {{ owner.display_name|default:owner.username }}</h4>
          </div>

          {# Botão seguir / deixar de seguir (somente quando não for o próprio usuário) #}
          <form method="post" action="{% url 'accounts:follow_toggle' owner.id %}" class="pt-5 mt-5 d-none d-md-block">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
            {% if is_following %}
              <button class="btn btn-sm btn-outline-secondary" type="submit">Deixar de seguir</button>
            {% else %}
              <button class="btn btn-sm btn-primary" type="submit">Seguir</button>
            {% endif %}
          </form>
        {% endif %}
      </div>
    </div>
  </div>
{% endwith %}
