{% extends 'base.html' %}

{% block content %}
  <div class="container mt-4" style="max-width: 820px;">
    <h2 class="mb-4">Cadastro de Usuário</h2>

    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <div class="mb-3">
        <label class="form-label">{{ form.username.label }}</label>
        {{ form.username }}
        {{ form.username.errors }}
      </div>

      <div class="mb-3">
        <label class="form-label">{{ form.display_name.label }}</label>
        {{ form.display_name }}
        {{ form.display_name.errors }}
      </div>

      <div class="mb-3">
        <label class="form-label">{{ form.email.label }}</label>
        {{ form.email }}
        {{ form.email.errors }}
      </div>

      <div class="mb-3">
        <label class="form-label">{{ form.role.label }}</label>
        {{ form.role }}
        {{ form.role.errors }}
      </div>

      <hr class="my-4" />

      <!-- Profile image -->
      <div class="mb-3">
        <label class="form-label">{{ form.profile_image.label }}</label>
        {{ form.profile_image }}
        {{ form.profile_image.errors }}
      </div>

      <!-- Profile editor -->
      <div id="profile-editor" class="img-editor-wrap mb-4" style="display:none;">
        <div class="card">
          <div class="card-body">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
              <strong>Ajuste da foto de perfil</strong>
              <small class="text-muted">Zoom: roda do mouse • Pan: arrastar</small>
            </div>

            <canvas id="profileCanvas" class="img-editor-canvas" width="420" height="420" style="width:100%; max-width:420px; border:1px solid rgba(255,255,255,.15); border-radius:.5rem; touch-action:none;"></canvas>

            <div class="d-flex gap-2 mt-3">
              <button type="button" id="btnProfileReset" class="btn btn-outline-secondary">Resetar</button>
              <button type="button" id="btnProfileApply" class="btn btn-success">Aplicar</button>
            </div>

            <div class="form-text mt-2">Ao aplicar, o arquivo enviado será o recorte final (quadrado).</div>
          </div>
        </div>
      </div>

      <!-- Background image -->
      <div class="mb-3">
        <label class="form-label">{{ form.background_image.label }}</label>
        {{ form.background_image }}
        {{ form.background_image.errors }}
      </div>

      <!-- Background editor (faixa) -->
      <div id="bg-editor" class="img-editor-wrap mb-4" style="display:none;">
        <div class="card">
          <div class="card-body">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
              <strong>Ajuste da imagem de fundo</strong>
              <small class="text-muted">Zoom: roda do mouse • Pan: arrastar</small>
            </div>

            <!-- Faixa: 1200x400 (3:1). Você pode ajustar. -->
            <canvas id="bgCanvas" class="img-editor-canvas" width="1200" height="400" style="width:100%; max-width:100%; border:1px solid rgba(255,255,255,.15); border-radius:.5rem; touch-action:none;"></canvas>

            <div class="d-flex gap-2 mt-3">
              <button type="button" id="btnBgReset" class="btn btn-outline-secondary">Resetar</button>
              <button type="button" id="btnBgApply" class="btn btn-success">Aplicar</button>
            </div>

            <div class="form-text mt-2">Ao aplicar, o arquivo enviado será o recorte final (faixa retangular).</div>
          </div>
        </div>
      </div>

      <hr class="my-4" />

      <div class="mb-3">
        <label class="form-label">{{ form.password1.label }}</label>
        {{ form.password1 }}
        {{ form.password1.errors }}
      </div>

      <div class="mb-3">
        <label class="form-label">{{ form.password2.label }}</label>
        {{ form.password2 }}
        {{ form.password2.errors }}
      </div>

      <div class="d-flex gap-2 mt-4">
        <a href="{% url 'home:index' %}" class="btn btn-outline-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Cadastrar</button>
      </div>
    </form>
  </div>

  <script>
    ;(function () {
      function clamp(v, a, b) {
        return Math.max(a, Math.min(b, v))
      }
    
      function createImageEditor(opts) {
        const fileInput = document.getElementById(opts.inputId)
        const wrap = document.getElementById(opts.wrapId)
        const canvas = document.getElementById(opts.canvasId)
    
        const btnReset = document.getElementById(opts.btnResetId)
        const btnApply = document.getElementById(opts.btnApplyId)
    
        if (!fileInput || !wrap || !canvas || !btnReset || !btnApply) return
    
        const ctx = canvas.getContext('2d')
    
        let img = new Image()
        let imgLoaded = false
    
        let scale = 1
        let minScale = 1
        const maxScale = opts.maxScale ?? 6
    
        let offsetX = 0
        let offsetY = 0
    
        let isPanning = false
        let startPanX = 0
        let startPanY = 0
        let startOffsetX = 0
        let startOffsetY = 0
    
        function fitToCanvas() {
          const sx = canvas.width / img.width
          const sy = canvas.height / img.height
          minScale = Math.max(sx, sy)
          scale = minScale
    
          const drawnW = img.width * scale
          const drawnH = img.height * scale
    
          offsetX = (canvas.width - drawnW) / 2
          offsetY = (canvas.height - drawnH) / 2
        }
    
        function boundOffsets() {
          const drawnW = img.width * scale
          const drawnH = img.height * scale
    
          const minX = canvas.width - drawnW
          const minY = canvas.height - drawnH
    
          if (drawnW <= canvas.width) offsetX = (canvas.width - drawnW) / 2
          else offsetX = clamp(offsetX, minX, 0)
    
          if (drawnH <= canvas.height) offsetY = (canvas.height - drawnH) / 2
          else offsetY = clamp(offsetY, minY, 0)
        }
    
        function draw() {
          if (!imgLoaded) return
    
          ctx.clearRect(0, 0, canvas.width, canvas.height)
          ctx.imageSmoothingEnabled = true
    
          const w = img.width * scale
          const h = img.height * scale
    
          ctx.drawImage(img, offsetX, offsetY, w, h)
    
          // moldura discreta
          ctx.save()
          ctx.strokeStyle = 'rgba(0,0,0,.35)'
          ctx.lineWidth = 2
          ctx.strokeRect(1, 1, canvas.width - 2, canvas.height - 2)
          ctx.restore()
        }
    
        function loadFile(file) {
          if (!file) return
    
          const url = URL.createObjectURL(file)
          img = new Image()
          img.onload = () => {
            imgLoaded = true
            wrap.style.display = 'block'
            fitToCanvas()
            boundOffsets()
            draw()
            URL.revokeObjectURL(url)
          }
          img.src = url
        }
    
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0]
          if (!file) return
          loadFile(file)
        })
    
        // Zoom (wheel)
        canvas.addEventListener(
          'wheel',
          (e) => {
            if (!imgLoaded) return
            e.preventDefault()
    
            const rect = canvas.getBoundingClientRect()
            const cx = e.clientX - rect.left
            const cy = e.clientY - rect.top
    
            const ix = (cx - offsetX) / scale
            const iy = (cy - offsetY) / scale
    
            const delta = e.deltaY < 0 ? 1.08 : 0.92
            const nextScale = clamp(scale * delta, minScale, maxScale)
    
            scale = nextScale
    
            offsetX = cx - ix * scale
            offsetY = cy - iy * scale
    
            boundOffsets()
            draw()
          },
          { passive: false }
        )
    
        // Pan (mouse)
        canvas.addEventListener('mousedown', (e) => {
          if (!imgLoaded) return
          isPanning = true
          startPanX = e.clientX
          startPanY = e.clientY
          startOffsetX = offsetX
          startOffsetY = offsetY
        })
    
        window.addEventListener('mousemove', (e) => {
          if (!isPanning) return
          const dx = e.clientX - startPanX
          const dy = e.clientY - startPanY
          offsetX = startOffsetX + dx
          offsetY = startOffsetY + dy
          boundOffsets()
          draw()
        })
    
        window.addEventListener('mouseup', () => {
          isPanning = false
        })
    
        // Pan (touch)
        canvas.addEventListener(
          'touchstart',
          (e) => {
            if (!imgLoaded) return
            if (e.touches.length !== 1) return
            isPanning = true
            startPanX = e.touches[0].clientX
            startPanY = e.touches[0].clientY
            startOffsetX = offsetX
            startOffsetY = offsetY
          },
          { passive: true }
        )
    
        canvas.addEventListener(
          'touchmove',
          (e) => {
            if (!isPanning) return
            if (e.touches.length !== 1) return
            const dx = e.touches[0].clientX - startPanX
            const dy = e.touches[0].clientY - startPanY
            offsetX = startOffsetX + dx
            offsetY = startOffsetY + dy
            boundOffsets()
            draw()
          },
          { passive: true }
        )
    
        canvas.addEventListener(
          'touchend',
          () => {
            isPanning = false
          },
          { passive: true }
        )
    
        btnReset.addEventListener('click', () => {
          if (!imgLoaded) return
          fitToCanvas()
          boundOffsets()
          draw()
        })
    
        btnApply.addEventListener('click', async () => {
          if (!imgLoaded) return
    
          const blob = await new Promise((resolve) => canvas.toBlob(resolve, opts.mimeType ?? 'image/jpeg', opts.quality ?? 0.9))
          if (!blob) return
    
          const originalName = fileInput.files && fileInput.files[0] && fileInput.files[0].name ? fileInput.files[0].name : opts.defaultName ?? 'image.jpg'
    
          const base = originalName.replace(/\.[^/.]+$/, '')
          const finalName = (opts.suffix ? base + opts.suffix : base + '_crop') + (opts.ext ?? '.jpg')
    
          const newFile = new File([blob], finalName, { type: blob.type })
    
          const dt = new DataTransfer()
          dt.items.add(newFile)
          fileInput.files = dt.files
        })
      }
    
      // Perfil: quadrado 420x420, PNG ou JPG (aqui usei JPG para reduzir tamanho)
      createImageEditor({
        inputId: 'id_profile_image',
        wrapId: 'profile-editor',
        canvasId: 'profileCanvas',
        btnResetId: 'btnProfileReset',
        btnApplyId: 'btnProfileApply',
        mimeType: 'image/jpeg',
        quality: 0.9,
        defaultName: 'profile.jpg',
        suffix: '_profile',
        ext: '.jpg',
        maxScale: 6
      })
    
      // Background: faixa 1200x400 (3:1)
      createImageEditor({
        inputId: 'id_background_image',
        wrapId: 'bg-editor',
        canvasId: 'bgCanvas',
        btnResetId: 'btnBgReset',
        btnApplyId: 'btnBgApply',
        mimeType: 'image/jpeg',
        quality: 0.9,
        defaultName: 'background.jpg',
        suffix: '_bg',
        ext: '.jpg',
        maxScale: 6
      })
    })()
  </script>
{% endblock %}
