{% extends 'base.html' %}

{% block content %}
  <div class="container mt-4" style="max-width: 820px;">
    <h2 class="mb-4">Cadastro de Usuário</h2>

    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <div class="mb-3">
        <label class="form-label">{{ form.username.label }}</label>
        {{ form.username }}
        {{ form.username.errors }}
      </div>

      <div class="mb-3">
        <label class="form-label">{{ form.display_name.label }}</label>
        {{ form.display_name }}
        {{ form.display_name.errors }}
      </div>

      <div class="mb-3">
        <label class="form-label">{{ form.email.label }}</label>
        {{ form.email }}
        {{ form.email.errors }}
      </div>

      <div class="mb-3">
        <label class="form-label">{{ form.role.label }}</label>
        {{ form.role }}
        {{ form.role.errors }}
      </div>

      <hr class="my-4" />

      <div class="mb-3">
        <label class="form-label">{{ form.profile_image.label }}</label>
        {{ form.profile_image }}
        {{ form.profile_image.errors }}
      </div>

      <div id="profile-editor" class="img-editor-wrap mb-4" style="display:none;">
        <div class="card">
          <div class="card-body">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
              <strong>Ajuste da foto de perfil</strong>

              <!-- Ajuda + atalhos (sem depender do scroll) -->
              <div class="d-flex flex-wrap align-items-center gap-2">
                <div class="btn-group btn-group-sm" role="group" aria-label="Controles de zoom (perfil)">
                  <button type="button" id="btnProfileZoomOut" class="btn btn-outline-light" title="Diminuir zoom (−)" aria-label="Diminuir zoom">−</button>
                  <button type="button" id="btnProfileZoomIn" class="btn btn-outline-light" title="Aumentar zoom (+)" aria-label="Aumentar zoom">+</button>
                </div>

                <button type="button" id="btnProfileCenter" class="btn btn-outline-light btn-sm" title="Centralizar imagem" aria-label="Centralizar imagem">Centralizar</button>

                <small class="text-muted">Zoom: botões (+/−) ou teclas (+/−) • Pan: arrastar • Centralizar: tecla (C)</small>
              </div>
            </div>

            <canvas id="profileCanvas" class="img-editor-canvas" width="420" height="420" style="width:100%; max-width:420px; border:1px solid rgba(255,255,255,.15); border-radius:.5rem; touch-action:none;"></canvas>

            <div class="d-flex flex-wrap gap-2 mt-3">
              <button type="button" id="btnProfileReset" class="btn btn-outline-secondary">Resetar</button>
              <button type="button" id="btnProfileApply" class="btn btn-success">Aplicar</button>

              <!-- Opcional: dica curta sempre visível -->
              <span class="badge text-bg-secondary align-self-center">Atalhos: + / − / 0 / C</span>
            </div>

            <div class="form-text mt-2">
              Ao aplicar, o arquivo enviado será o recorte final (quadrado). Tecla <kbd>0</kbd> reseta.
            </div>
          </div>
        </div>
      </div>

      <!-- Background image -->
      <div class="mb-3">
        <label class="form-label">{{ form.background_image.label }}</label>
        {{ form.background_image }}
        {{ form.background_image.errors }}
      </div>

      <!-- Background editor (faixa) -->
      <div id="bg-editor" class="img-editor-wrap mb-4" style="display:none;">
        <div class="card">
          <div class="card-body">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
              <strong>Ajuste da imagem de fundo</strong>

              <div class="d-flex flex-wrap align-items-center gap-2">
                <div class="btn-group btn-group-sm" role="group" aria-label="Controles de zoom (fundo)">
                  <button type="button" id="btnBgZoomOut" class="btn btn-outline-light" title="Diminuir zoom (−)" aria-label="Diminuir zoom">−</button>
                  <button type="button" id="btnBgZoomIn" class="btn btn-outline-light" title="Aumentar zoom (+)" aria-label="Aumentar zoom">+</button>
                </div>

                <button type="button" id="btnBgCenter" class="btn btn-outline-light btn-sm" title="Centralizar imagem" aria-label="Centralizar imagem">Centralizar</button>

                <small class="text-muted">Zoom: botões (+/−) ou teclas (+/−) • Pan: arrastar • Centralizar: tecla (C)</small>
              </div>
            </div>

            <!-- Faixa: 1200x400 (3:1) -->
            <canvas id="bgCanvas" class="img-editor-canvas" width="1200" height="400" style="width:100%; max-width:100%; border:1px solid rgba(255,255,255,.15); border-radius:.5rem; touch-action:none;"></canvas>

            <div class="d-flex flex-wrap gap-2 mt-3">
              <button type="button" id="btnBgReset" class="btn btn-outline-secondary">Resetar</button>
              <button type="button" id="btnBgApply" class="btn btn-success">Aplicar</button>

              <span class="badge text-bg-secondary align-self-center">Atalhos: + / − / 0 / C</span>
            </div>

            <div class="form-text mt-2">
              Ao aplicar, o arquivo enviado será o recorte final (faixa retangular). Tecla <kbd>0</kbd> reseta.
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4" />

      <div class="mb-3">
        <label class="form-label">{{ form.password1.label }}</label>
        {{ form.password1 }}
        {{ form.password1.errors }}
      </div>

      <div class="mb-3">
        <label class="form-label">{{ form.password2.label }}</label>
        {{ form.password2 }}
        {{ form.password2.errors }}
      </div>

      <div class="d-flex gap-2 mt-4">
        <a href="{% url 'home:index' %}" class="btn btn-outline-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Cadastrar</button>
      </div>
    </form>
  </div>

<script>
;(function () {
  function clamp(v, a, b) {
    return Math.max(a, Math.min(b, v))
  }

  function createImageEditor(opts) {
    const fileInput = document.getElementById(opts.inputId)
    const wrap = document.getElementById(opts.wrapId)
    const canvas = document.getElementById(opts.canvasId)

    const btnReset = document.getElementById(opts.btnResetId)
    const btnApply = document.getElementById(opts.btnApplyId)

    // NOVOS (opcionais)
    const btnZoomIn = opts.btnZoomInId ? document.getElementById(opts.btnZoomInId) : null
    const btnZoomOut = opts.btnZoomOutId ? document.getElementById(opts.btnZoomOutId) : null
    const btnCenter = opts.btnCenterId ? document.getElementById(opts.btnCenterId) : null

    if (!fileInput || !wrap || !canvas || !btnReset || !btnApply) return

    const ctx = canvas.getContext('2d')

    let img = new Image()
    let imgLoaded = false

    let scale = 1
    let minScale = 1
    const maxScale = opts.maxScale ?? 6

    let offsetX = 0
    let offsetY = 0

    let isPanning = false
    let startPanX = 0
    let startPanY = 0
    let startOffsetX = 0
    let startOffsetY = 0

    // Para atalhos: qual editor está "ativo"
    function markActive() {
      window.__activeImgEditor = api
    }

    function fitToCanvas() {
      const sx = canvas.width / img.width
      const sy = canvas.height / img.height
      minScale = Math.max(sx, sy)
      scale = minScale

      const drawnW = img.width * scale
      const drawnH = img.height * scale

      offsetX = (canvas.width - drawnW) / 2
      offsetY = (canvas.height - drawnH) / 2
    }

    function boundOffsets() {
      const drawnW = img.width * scale
      const drawnH = img.height * scale

      const minX = canvas.width - drawnW
      const minY = canvas.height - drawnH

      if (drawnW <= canvas.width) offsetX = (canvas.width - drawnW) / 2
      else offsetX = clamp(offsetX, minX, 0)

      if (drawnH <= canvas.height) offsetY = (canvas.height - drawnH) / 2
      else offsetY = clamp(offsetY, minY, 0)
    }

    function draw() {
      if (!imgLoaded) return

      ctx.clearRect(0, 0, canvas.width, canvas.height)
      ctx.imageSmoothingEnabled = true

      const w = img.width * scale
      const h = img.height * scale
      ctx.drawImage(img, offsetX, offsetY, w, h)

      // moldura discreta
      ctx.save()
      ctx.strokeStyle = 'rgba(0,0,0,.35)'
      ctx.lineWidth = 2
      ctx.strokeRect(1, 1, canvas.width - 2, canvas.height - 2)
      ctx.restore()
    }

    function center() {
      if (!imgLoaded) return
      const drawnW = img.width * scale
      const drawnH = img.height * scale
      offsetX = (canvas.width - drawnW) / 2
      offsetY = (canvas.height - drawnH) / 2
      boundOffsets()
      draw()
    }

    function reset() {
      if (!imgLoaded) return
      fitToCanvas()
      boundOffsets()
      draw()
    }

    function zoomAtPoint(cx, cy, factor) {
      if (!imgLoaded) return

      // ponto na imagem (em coordenadas do bitmap original)
      const ix = (cx - offsetX) / scale
      const iy = (cy - offsetY) / scale

      const nextScale = clamp(scale * factor, minScale, maxScale)
      if (nextScale === scale) return

      scale = nextScale
      offsetX = cx - ix * scale
      offsetY = cy - iy * scale

      boundOffsets()
      draw()
    }

    function zoomBy(factor) {
      // zoom centrado no meio do canvas (para botões/atalhos)
      zoomAtPoint(canvas.width / 2, canvas.height / 2, factor)
    }

    function loadFile(file) {
      if (!file) return

      const url = URL.createObjectURL(file)
      img = new Image()
      img.onload = () => {
        imgLoaded = true
        wrap.style.display = 'block'
        fitToCanvas()
        boundOffsets()
        draw()
        URL.revokeObjectURL(url)
      }
      img.src = url
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0]
      if (!file) return
      loadFile(file)
    })

    // Ativa editor ao interagir (mouse/touch)
    canvas.addEventListener('pointerdown', markActive)
    canvas.addEventListener('mouseenter', markActive)
    wrap.addEventListener('pointerdown', markActive)

    // Zoom (wheel)
    canvas.addEventListener(
      'wheel',
      (e) => {
        if (!imgLoaded) return
        e.preventDefault()
        markActive()

        const rect = canvas.getBoundingClientRect()
        const cx = e.clientX - rect.left
        const cy = e.clientY - rect.top

        const factor = e.deltaY < 0 ? (opts.wheelZoomIn ?? 1.08) : (opts.wheelZoomOut ?? 0.92)
        zoomAtPoint(cx, cy, factor)
      },
      { passive: false }
    )

    // Pan (mouse)
    canvas.addEventListener('mousedown', (e) => {
      if (!imgLoaded) return
      markActive()

      isPanning = true
      startPanX = e.clientX
      startPanY = e.clientY
      startOffsetX = offsetX
      startOffsetY = offsetY

      // evita arrastar imagem fantasma
      e.preventDefault()
    })

    window.addEventListener('mousemove', (e) => {
      if (!isPanning) return
      const dx = e.clientX - startPanX
      const dy = e.clientY - startPanY
      offsetX = startOffsetX + dx
      offsetY = startOffsetY + dy
      boundOffsets()
      draw()
    })

    window.addEventListener('mouseup', () => {
      isPanning = false
    })

    // Pan (touch)
    canvas.addEventListener(
      'touchstart',
      (e) => {
        if (!imgLoaded) return
        if (e.touches.length !== 1) return
        markActive()

        isPanning = true
        startPanX = e.touches[0].clientX
        startPanY = e.touches[0].clientY
        startOffsetX = offsetX
        startOffsetY = offsetY
      },
      { passive: true }
    )

    canvas.addEventListener(
      'touchmove',
      (e) => {
        if (!isPanning) return
        if (e.touches.length !== 1) return
        const dx = e.touches[0].clientX - startPanX
        const dy = e.touches[0].clientY - startPanY
        offsetX = startOffsetX + dx
        offsetY = startOffsetY + dy
        boundOffsets()
        draw()
      },
      { passive: true }
    )

    canvas.addEventListener(
      'touchend',
      () => {
        isPanning = false
      },
      { passive: true }
    )

    btnReset.addEventListener('click', () => {
      reset()
      markActive()
    })

    btnApply.addEventListener('click', async () => {
      if (!imgLoaded) return

      const blob = await new Promise((resolve) =>
        canvas.toBlob(resolve, opts.mimeType ?? 'image/jpeg', opts.quality ?? 0.9)
      )
      if (!blob) return

      const originalName =
        fileInput.files && fileInput.files[0] && fileInput.files[0].name
          ? fileInput.files[0].name
          : opts.defaultName ?? 'image.jpg'

      const base = originalName.replace(/\.[^/.]+$/, '')
      const finalName = (opts.suffix ? base + opts.suffix : base + '_crop') + (opts.ext ?? '.jpg')

      const newFile = new File([blob], finalName, { type: blob.type })

      const dt = new DataTransfer()
      dt.items.add(newFile)
      fileInput.files = dt.files

      // se quiser, pode esconder o editor após aplicar:
      // wrap.style.display = 'none'
    })

    // Botões extras (zoom/centralizar)
    const btnStep = opts.btnZoomStep ?? 1.12
    if (btnZoomIn) btnZoomIn.addEventListener('click', () => { zoomBy(btnStep); markActive() })
    if (btnZoomOut) btnZoomOut.addEventListener('click', () => { zoomBy(1 / btnStep); markActive() })
    if (btnCenter) btnCenter.addEventListener('click', () => { center(); markActive() })

    // API exposta (para atalhos globais)
    const api = { canvas, wrap, zoomBy, reset, center, isReady: () => imgLoaded }
    return api
  }

  // Atalhos globais (age no último editor tocado/clicado)
  ;(function bindGlobalShortcuts() {
    function isEditableTarget(t) {
      if (!t) return false
      const tag = (t.tagName || '').toLowerCase()
      return tag === 'input' || tag === 'textarea' || t.isContentEditable
    }
    function isZoomInKey(e) {
      return e.key === '+' || e.key === '='
    }
    function isZoomOutKey(e) {
      return e.key === '-' || e.key === '_'
    }

    document.addEventListener('keydown', (e) => {
      if (isEditableTarget(e.target)) return

      const active = window.__activeImgEditor
      if (!active || !active.isReady()) return

      if (isZoomInKey(e)) { e.preventDefault(); active.zoomBy(1.12) }
      else if (isZoomOutKey(e)) { e.preventDefault(); active.zoomBy(1 / 1.12) }
      else if (e.key === '0') { e.preventDefault(); active.reset() }
      else if (e.key.toLowerCase() === 'c') { e.preventDefault(); active.center() }
    })
  })()

  // Perfil
  createImageEditor({
    inputId: 'id_profile_image',
    wrapId: 'profile-editor',
    canvasId: 'profileCanvas',
    btnResetId: 'btnProfileReset',
    btnApplyId: 'btnProfileApply',

    // NOVOS IDs (se você adicionou no HTML)
    btnZoomInId: 'btnProfileZoomIn',
    btnZoomOutId: 'btnProfileZoomOut',
    btnCenterId: 'btnProfileCenter',

    mimeType: 'image/jpeg',
    quality: 0.9,
    defaultName: 'profile.jpg',
    suffix: '_profile',
    ext: '.jpg',
    maxScale: 6,
    btnZoomStep: 1.12
  })

  // Background
  createImageEditor({
    inputId: 'id_background_image',
    wrapId: 'bg-editor',
    canvasId: 'bgCanvas',
    btnResetId: 'btnBgReset',
    btnApplyId: 'btnBgApply',

    // NOVOS IDs (se você adicionou no HTML)
    btnZoomInId: 'btnBgZoomIn',
    btnZoomOutId: 'btnBgZoomOut',
    btnCenterId: 'btnBgCenter',

    mimeType: 'image/jpeg',
    quality: 0.9,
    defaultName: 'background.jpg',
    suffix: '_bg',
    ext: '.jpg',
    maxScale: 6,
    btnZoomStep: 1.12
  })
})()
</script>

{% endblock %}
