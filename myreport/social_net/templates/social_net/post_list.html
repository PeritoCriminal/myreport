{# templates/social_net/post_list.html #}
{% extends 'base.html' %}
{% load static %}

{% block page_header %}
  {% include 'headerbars/profile_header.html' %}
{% endblock %}

{% block content %}
  <div class="mt-4">
    <div class="row justify-content-center g-0">
      <div class="col-12 col-lg-8 px-0">
        {% include 'partials/action_header.html' with show_search=True search_placeholder='Buscar postagens' action_label='Nova postagem' action_toggle='collapse' action_target='#postFormCollapse' %}

        {# Form reutilizável #}
        {% include 'social_net/partials/post_create_form.html' %}

        <div id="posts-feed">
          {% for post in posts %}
            {% include 'social_net/partials/post_item.html' with post=post %}
          {% empty %}
            <div class="alert alert-secondary">Nenhuma postagem encontrada.</div>
          {% endfor %}
        </div>

        {% if is_paginated %}
          <nav class="mt-3" aria-label="Paginação de postagens">
            <ul class="pagination justify-content-center mb-0">
              <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                {% if page_obj.has_previous %}
                  <a class="page-link"
                    href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}"
                    aria-label="Anterior">
                    &laquo;
                  </a>
                {% else %}
                  <span class="page-link" aria-label="Anterior">&laquo;</span>
                {% endif %}
              </li>

              <li class="page-item disabled">
                <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
              </li>

              <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                {% if page_obj.has_next %}
                  <a class="page-link"
                    href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}"
                    aria-label="Próxima">
                    &raquo;
                  </a>
                {% else %}
                  <span class="page-link" aria-label="Próxima">&raquo;</span>
                {% endif %}
              </li>
            </ul>
          </nav>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'js/social_net/post_form.js' %}"></script>

  {% if request.GET.new %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const collapseEl = document.getElementById('postFormCollapse')
        if (!collapseEl) return

        // abre o formulário
        const c = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false })
        c.show()
        collapseEl.scrollIntoView({ behavior: 'smooth', block: 'start' })

        const params = new URLSearchParams(window.location.search)

        // ---------- pré-preenchimento ----------
        const title = params.get('title')
        if (title) {
          const titleInput = document.getElementById('{{ form.title.id_for_label }}')
          if (titleInput) titleInput.value = title
        }

        const text = params.get('text')
        if (text) {
          const textInput = document.getElementById('{{ form.text.id_for_label }}')
          if (textInput) textInput.value = text
        }

        // ---------- destino ----------
        const groupSelect = document.getElementById('{{ form.group.id_for_label }}')
        if (groupSelect) {
          const group = params.get('group')
          groupSelect.value = group ? group : ''
        }

        const url = params.get('url')
        if (url) {
          const urlInput = document.getElementById('id_related_url')
          if (urlInput) urlInput.value = url
        }

        // ---------- preview padrão (PDF) ----------
        const share = params.get('share')
        if (share === 'pdf') {
          const wrap = document.getElementById('post-media-preview-wrapper')
          const img = document.getElementById('post-media-preview')

          if (wrap && img) {
            img.src = "{% static 'technical_repository/img/pdf.png' %}"
            wrap.classList.remove('d-none')
          }
        }
      })
    </script>
  {% endif %}
{% endblock %}

