{% extends 'base.html' %}

{% block content %}
  <div class="container mt-4" style="max-width: 820px;">
    <h2 class="mb-4">Postagens</h2>

    <!-- Formulário de criação de post -->
    <div class="card mb-4">
      <div class="card-body">
        <form id="post-form" method="post" enctype="multipart/form-data" action="{% url 'social_net:post_create' %}">
          {% csrf_token %}

          <div id="post-form-errors"></div>

          <div class="mb-2">{{ form.title }}</div>
          <div class="mb-2">{{ form.text }}</div>

          <div class="mb-2">
            <label class="form-label mb-1">Mídia</label>
            {{ form.media }}
          </div>

          <div class="text-end">
            <button class="btn btn-primary btn-sm" type="submit">Publicar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Lista de posts -->
    <div id="feed">
      {% for post in posts %}
        {% include 'social_net/partials/post_item.html' %}
      {% endfor %}
    </div>
  </div>

  <script>
    ;(function () {
      const form = document.getElementById('post-form')
      const feed = document.getElementById('feed')
      const errorsWrap = document.getElementById('post-form-errors')
    
      form.addEventListener('submit', async (e) => {
        e.preventDefault()
        errorsWrap.innerHTML = ''
    
        const resp = await fetch(form.action, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: new FormData(form)
        })
    
        if (resp.ok) {
          const data = await resp.json()
          feed.insertAdjacentHTML('afterbegin', data.html) // Insere o post no topo do feed
          form.reset()
          return
        }
    
        const data = await resp.json().catch(() => null)
        if (data && data.errors_html) {
          errorsWrap.innerHTML = data.errors_html
        } else {
          errorsWrap.innerHTML = '<div class="alert alert-danger py-2 my-2">Erro ao publicar.</div>'
        }
      })
    })()
  </script>
{% endblock %}
