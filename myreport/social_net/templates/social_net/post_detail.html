{# templates/social_net/post_detail.html #}
{% extends 'base.html' %}
{% load static %}

{% block page_header %}
  {# Exibe o autor da postagem #}
  {% include 'accounts/partials/profile_header.html' with owner=post.user %}
{% endblock %}

{% block content %}
  <div class="container mt-4" style="max-width: 820px;">
    {# ===================== Post (sem borda) ===================== #}
    <div class="mb-4" id="post-{{ post.id }}">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <small class="text-muted">{{ post.created_at }}</small>

        {# Deletar (inativar) - apenas autor #}
        {% if request.user.id == post.user_id %}
          <button
            type="button"
            class="btn btn-sm btn-link text-danger p-0 js-post-delete"
            data-delete-url="{% url 'social_net:post_delete' post.id %}"
            data-post-id="{{ post.id }}"
            title="Excluir postagem"
          >
            <i class="bi bi-trash"></i>
          </button>
        {% endif %}
      </div>

      {% if post.title %}
        <h5 class="mb-2">{{ post.title }}</h5>
      {% endif %}

      {% if post.text %}
        <p class="mb-3">{{ post.text|linebreaksbr }}</p>
      {% endif %}

      {% if post.media %}
        <div class="mb-3">
          {% with url=post.media.url|lower %}
            {% if '.jpg' in url or '.jpeg' in url or '.png' in url or '.webp' in url %}
              <img src="{{ post.media.url }}" class="img-fluid rounded" alt="Imagem da postagem" />
            {% elif '.mp4' in url or '.webm' in url or '.ogg' in url %}
              <video controls class="img-fluid rounded" playsinline preload="metadata">
                <source src="{{ post.media.url }}" />
                Seu navegador não suporta vídeo HTML5.
              </video>
            {% else %}
              <a href="{{ post.media.url }}" target="_blank" rel="noopener">Abrir mídia</a>
            {% endif %}
          {% endwith %}
        </div>
      {% endif %}
    </div>

    <div class="d-flex flex-wrap align-items-center gap-4 mb-3 text-muted small">
      <span class="d-flex align-items-center gap-1">
        <i class="bi bi-heart-fill text-danger"></i>
        <strong class="text-body">{{ likes_count }}</strong>
        <span>curtidas</span>
      </span>

      <span class="d-flex align-items-center gap-1">
        <i class="bi bi-star-fill text-warning"></i>
        <strong class="text-body">{{ rating_avg|floatformat:1 }}</strong>
        <span>({{ rating_total }} avaliações)</span>
      </span>
    </div>

    {# ===================== Comentários (recuo à esquerda) ===================== #}
    <div class="card border-0 shadow-sm mb-3 ms-3">
      <div class="card-body py-3">
        <h6 class="mb-3">Comentários ({{ comments.count }})</h6>

        {% for comment in comments %}
          <div class="mb-3 border-bottom pb-2" id="comment-{{ comment.id }}">
            <div class="d-flex justify-content-between align-items-start">
              <div class="d-flex align-items-center gap-2">
                {% if comment.user.profile_image %}
                  <img
                    src="{{ comment.user.profile_image.url }}"
                    alt="Foto de perfil"
                    class="rounded-circle border"
                    style="width:32px; height:32px; object-fit:cover;"
                  />
                {% else %}
                  <div class="rounded-circle bg-secondary" style="width:32px; height:32px;"></div>
                {% endif %}
                <strong class="small">{{ comment.user }}</strong>
              </div>

              <div class="d-flex align-items-center gap-2">
                <small class="text-muted">{{ comment.created_at }}</small>

                {# Deletar (inativar) - apenas autor do comentário #}
                {% if request.user.id == comment.user_id %}
                  <button
                    type="button"
                    class="btn btn-sm btn-link text-danger p-0 js-comment-delete"
                    data-comment-id="{{ comment.id }}"
                    data-delete-url="{% url 'social_net:comment_delete' comment.id %}"
                    title="Excluir comentário"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                {% endif %}
              </div>
            </div>

            {% if comment.text %}
              <p class="mb-1 mt-1">{{ comment.text|linebreaksbr }}</p>
            {% endif %}

            {% if comment.image %}
              <div class="mt-2">
                <img
                  src="{{ comment.image.url }}"
                  alt="Imagem do comentário"
                  class="rounded border"
                  style="max-width: 320px; width: 100%; height: auto;"
                />
              </div>
            {% endif %}
          </div>
        {% empty %}
          <p class="text-muted mb-0">Nenhum comentário até o momento.</p>
        {% endfor %}
      </div>
    </div>

    {# ===================== Formulário de comentário ===================== #}
    <div class="card border-0 shadow-sm ms-3">
      <div class="card-body py-3">
        <h6 class="mb-2">Adicionar comentário</h6>
        {% include 'social_net/partials/comment_form.html' with post=post force_open=True %}
      </div>
    </div>
  </div>
{% endblock %}


{% block scripts %}
  <script src="{% static 'js/social_net/post_form.js' %}"></script>
{% endblock %}