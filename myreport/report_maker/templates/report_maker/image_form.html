{# report_maker/templates/report_maker/image_form.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}
  {% if object %}Editar imagem{% else %}Adicionar imagem{% endif %}
{% endblock %}

{% block page_header %}
  {% include 'headerbars/report_maker.html' %}
{% endblock %}

{% block content %}
  <div class="container mt-4" style="max-width: 980px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">
        {% if object %}Editar imagem{% else %}Adicionar imagem{% endif %}
      </h4>
    </div>

    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.GET.next }}">

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <div class="image-editor card shadow-sm"
           data-editor
           data-mode="{{ mode|default:'create' }}"
           {% if initial_image_url %}data-initial-image-url="{{ initial_image_url }}"{% endif %}>

        {# Barra superior #}
        <div class="card-header py-2">
          <div class="d-flex flex-wrap align-items-center gap-2">

            <div class="btn-group btn-group-sm" role="group" aria-label="Arquivo">
              <button type="button" class="btn btn-outline-secondary" data-action="pick_file" title="Selecionar imagem">
                <i class="bi bi-folder2-open"></i>
              </button>
            </div>

            <div class="btn-group btn-group-sm" role="group" aria-label="Zoom">
              <button type="button" class="btn btn-outline-secondary" data-action="zoom_out" title="Zoom -">
                <i class="bi bi-zoom-out"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary" data-action="zoom_reset" title="Reset zoom">
                <i class="bi bi-aspect-ratio"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary" data-action="zoom_in" title="Zoom +">
                <i class="bi bi-zoom-in"></i>
              </button>
            </div>

            <div class="btn-group btn-group-sm" role="group" aria-label="Rotação">
              <button type="button" class="btn btn-outline-secondary" data-action="rotate_left" title="Rotacionar -90°">
                <i class="bi bi-arrow-counterclockwise"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary" data-action="rotate_right" title="Rotacionar +90°">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>

            <div class="btn-group btn-group-sm" role="group" aria-label="Recorte">
              <button type="button" class="btn btn-outline-secondary" data-action="crop_start" title="Recortar">
                <i class="bi bi-crop"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary" data-action="crop_apply" title="Aplicar recorte">
                <i class="bi bi-check2"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary" data-action="crop_cancel" title="Cancelar recorte">
                <i class="bi bi-x"></i>
              </button>
            </div>

            <div class="btn-group btn-group-sm" role="group" aria-label="Blur">
              <button type="button" class="btn btn-outline-secondary" data-action="blur_toggle" title="Desfoque">
                <i class="bi bi-droplet-half"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary" data-action="blur_clear" title="Limpar desfoque">
                <i class="bi bi-eraser"></i>
              </button>
            </div>

            <div class="btn-group btn-group-sm ms-auto" role="group" aria-label="Ações gerais">
              <button type="button" class="btn btn-outline-secondary" data-action="reset_all" title="Resetar tudo">
                <i class="bi bi-arrow-repeat"></i>
              </button>
            </div>

          </div>
        </div>

        <div class="card-body">

          {# Input de arquivo oculto #}
          <div class="mb-3 d-none" data-file-row>
            <label class="form-label mb-1">Arquivo</label>
            {{ form.image }}
            {% if form.image.errors %}
              <div class="text-danger small mt-1">{{ form.image.errors }}</div>
            {% endif %}
          </div>

          {# Wrapper para alinhar escala + canvas + legenda na mesma largura #}
          <div class="mx-auto" data-stage-wrap style="width: 100%;">

            {# Régua 0..14 #}
            <div class="rm-ruler mb-2" data-scale-wrap>
              <div class="rm-ruler-line">
                <div class="rm-tick major"><span class="rm-label">0</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">1</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">2</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">3</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">4</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">5</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">6</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">7</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">8</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">9</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">10</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">11</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">12</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">13</span></div>
                <div class="rm-tick minor"></div>
                <div class="rm-tick major"><span class="rm-label">14</span></div>
              </div>
            </div>

            {# Stage (canvas) #}
            <div class="border rounded-3 bg-light w-100" data-stage style="overflow:hidden;">
              <canvas data-canvas style="display:block; width:100%;"></canvas>
            </div>

            <div class="mt-3 w-100" data-caption-wrap>
              {% with field=form.caption %}
                {% include "report_maker/partials/text_block_editor.html" with field_name=field.name label=field.label value=field.value help_text=field.help_text rows=8 %}
              {% endwith %}

              {% if form.caption.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.caption.errors|striptags }}
                </div>
              {% endif %}
            </div>


          </div>

        </div>

        <div class="card-footer d-flex gap-2 justify-content-end">
          <a href="{{ cancel_url }}" class="btn btn-outline-secondary btn-sm">
            Cancelar
          </a>

          {# preserva a URL de origem (?next=) no POST #}
          <input type="hidden" name="next" value="{{ request.GET.next }}">

          <button type="submit" class="btn btn-primary btn-sm" data-action="save">
            <i class="bi bi-check-lg"></i> Salvar
          </button>
        </div>

        </div>

      </div>

    </form>
  </div>

  {# CSS escopado do editor e da régua #}
  <style>
    .image-editor .rm-ruler { width: 100%; }
    .image-editor .rm-ruler-line {
      display: flex;
      align-items: flex-end;
      width: 100%;
      height: 22px;
      border-bottom: 1px solid #000;
      gap: 0;
    }
    .image-editor .rm-tick {
      flex: 1 1 0;
      position: relative;
      text-align: center;
      min-width: 0;
    }
    .image-editor .rm-tick.major::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 1px;
      height: 14px;
      background: #000;
    }
    .image-editor .rm-tick.minor::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 1px;
      height: 6px;
      background: #000;
    }
    .image-editor .rm-label {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      line-height: 1;
      white-space: nowrap;
      color: #000;
      user-select: none;
    }
    .image-editor [data-stage] canvas { display:block; width:100%; height:100%; }
  </style>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const editor = document.querySelector("[data-editor]");
  if (!editor) return;

  const mode = (editor.dataset.mode || "create").toLowerCase();
  const initialUrl = editor.dataset.initialImageUrl || "";

  console.log("mode:", mode);
  console.log("initialUrl:", initialUrl);

  const stage = editor.querySelector("[data-stage]");
  const canvas = editor.querySelector("[data-canvas]");
  const fileInput = editor.querySelector("[data-file-row] input[type='file']");

  if (!stage || !canvas || !fileInput) {
    console.warn("Editor: elementos obrigatórios não encontrados");
    return;
  }

  const ctx = canvas.getContext("2d");
  let currentImage = null;

  function clearCanvas() {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function fitCanvasToImage(img) {
    const stageW = stage.clientWidth || 1;
    const imgW = img.naturalWidth || img.width || 1;
    const imgH = img.naturalHeight || img.height || 1;

    const cssW = stageW;
    const cssH = Math.max(1, Math.round(cssW * (imgH / imgW)));

    // força o stage a ter a mesma altura do canvas
    stage.style.height = cssH + "px";

    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);

    canvas.style.width = cssW + "px";
    canvas.style.height = cssH + "px";

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    clearCanvas();
    ctx.drawImage(img, 0, 0, cssW, cssH);
  }


  function loadImageFromURL(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = url;
    });
  }

  function loadImageFromFile(file) {
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(file);
      const img = new Image();

      img.onload = () => {
        URL.revokeObjectURL(url);
        resolve(img);
      };
      img.onerror = (e) => {
        URL.revokeObjectURL(url);
        reject(e);
      };

      img.src = url;
    });
  }

  async function renderFileOnCanvas(file) {
    if (!file) return;
    try {
      const img = await loadImageFromFile(file);
      currentImage = img;
      fitCanvasToImage(img);
    } catch (err) {
      console.error("Falha ao carregar arquivo no canvas:", err);
    }
  }

  async function renderInitialOnCanvas(url) {
    if (!url) return;
    try {
      const img = await loadImageFromURL(url);
      currentImage = img;
      fitCanvasToImage(img);
    } catch (err) {
      console.error("Falha ao carregar imagem inicial:", err);
    }
  }

  // Botão "Selecionar imagem"
  editor.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;

    const action = btn.dataset.action;
    if (action === "pick_file") {
      fileInput.click();
    }
  });

  // Ao escolher arquivo, renderiza
  fileInput.addEventListener("change", () => {
    const file = fileInput.files?.[0];
    renderFileOnCanvas(file);
  });

  // Ajusta canvas se a tela mudar
  window.addEventListener("resize", () => {
    if (currentImage) fitCanvasToImage(currentImage);
  });

  // Comportamento de entrada
  // - create: abrir seletor na primeira interação do usuário (Chrome exige user activation)
  // - update/edit: carrega imagem do BD (data-initial-image-url)
  if ((mode === "create" || mode === "new") && !initialUrl) {
    const openOnce = () => {
      fileInput.click();
      editor.removeEventListener("pointerdown", openOnce);
      editor.removeEventListener("keydown", openOnce);
    };
    editor.addEventListener("pointerdown", openOnce, { once: true });
    editor.addEventListener("keydown", openOnce, { once: true });
  } else if (initialUrl) {
    renderInitialOnCanvas(initialUrl);
  }
})();
</script>
{% endblock %}
