{# templates/report_maker/reportcase_preview.html #}
{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
  <head>
    {% comment %}───────────────────────────────────────────────────────────── Metadados do documento ─────────────────────────────────────────────────────────────{% endcomment %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Laudo nº {{ report.report_number }}</title>

    {% comment %}───────────────────────────────────────────────────────────── CSS (vendor + feature) ─────────────────────────────────────────────────────────────{% endcomment %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'report_maker/css/report_preview.css' %}" />
    <link rel="stylesheet" href="{% static 'report_maker/css/report_print.css' %}" />
  </head>

  <body>
    {% comment %}───────────────────────────────────────────────────────────── Controles do preview ─────────────────────────────────────────────────────────────{% endcomment %}
    <button type="button" class="btn btn-light close-btn" data-action="close-preview">Fechar</button>

    {% comment %}───────────────────────────────────────────────────────────── Stage do preview e página do laudo ─────────────────────────────────────────────────────────────{% endcomment %}
    <main class="report-stage">
      <section class="report-page">
        {% comment %}───────────────────────────────────────────────────────── Cabeçalho institucional ─────────────────────────────────────────────────────────{% endcomment %}
        <header class="text-center">
          <table class="report-header" role="presentation">
            <tr>
              <td class="rh-img rh-left">
                {% if header.emblem_primary %}
                  <img src="{{ header.emblem_primary.url }}" alt="Emblema" class="rh-emblem" />
                {% endif %}
              </td>

              <td class="rh-center">
                <div class="rh-line rh-1">SECRETARIA DA SEGURANÇA PÚBLICA</div>

                {% if header.name or header.acronym %}
                  <div class="rh-line rh-2">
                    {{ header.name|default:'' }}
                    {% if header.acronym %}
                      ({{ header.acronym }})
                    {% endif %}
                  </div>
                {% endif %}

                {% if header.kind_display %}
                  <div class="rh-line rh-3">{{ header.kind_display }}</div>
                {% endif %}

                {% if header.honoree_line %}
                  <div class="rh-line rh-4">"{{ header.honoree_line|upper }}"</div>
                {% endif %}

                {% if header.unit_line %}
                  <div class="rh-line rh-5">{{ header.unit_line }}</div>
                {% endif %}
              </td>

              <td class="rh-img rh-right">
                {% if header.emblem_secondary %}
                  <img src="{{ header.emblem_secondary.url }}" alt="Emblema" class="rh-emblem" />
                {% endif %}
              </td>
            </tr>
          </table>

          <div class="report-number">LAUDO Nº {{ report.report_number }}</div>
        </header>

        {% comment %}───────────────────────────────────────────────────────── Preâmbulo ─────────────────────────────────────────────────────────{% endcomment %}
        {% if report.preamble %}
          <section class="report-section preamble">{{ report.preamble|linebreaks }}</section>
        {% endif %}

        {% comment %}───────────────────────────────────────────────────────── Dados da Requisição ─────────────────────────────────────────────────────────{% endcomment %}
        <section class="report-section">
          <h2 class="section-heading">Dados da Requisição</h2>

          <dl class="data-list">
            <dt>Autoridade requisitante</dt>
            <dd>{{ report.requesting_authority|default:'—' }}</dd>

            <dt>Distrito policial</dt>
            <dd>{{ report.police_station|default:'—' }}</dd>

            <dt>Boletim de ocorrência</dt>
            <dd>{{ report.police_report|default:'—' }}</dd>

            <dt>Data e hora do boletim</dt>
            <dd>
              {% if report.occurrence_datetime %}
                {{ report.occurrence_datetime|date:'d/m/Y H:i' }}
              {% else %}
                —
              {% endif %}
            </dd>

            <dt>Natureza criminal</dt>
            <dd>{{ report.criminal_typification|default:'—' }}</dd>
          </dl>
        </section>

        {% comment %}───────────────────────────────────────────────────────── Dados do Atendimento ─────────────────────────────────────────────────────────{% endcomment %}
        <section class="report-section">
          <h2 class="section-heading">Dados do Atendimento</h2>

          <dl class="data-list">
            <dt>Protocolo</dt>
            <dd>{{ report.protocol|default:'—' }}</dd>

            <dt>Data e hora do atendimento</dt>
            <dd>
              {% if report.examination_datetime %}
                {{ report.examination_datetime|date:'d/m/Y H:i' }}
              {% else %}
                —
              {% endif %}
            </dd>

            <dt>Perito</dt>
            <dd>{{ report.author.report_signature_name|default:'—' }}</dd>
          </dl>
        </section>

        {% comment %}───────────────────────────────────────────────────────── Objetos Examinados ───────────────────────────────────────────────────────── Contexto esperado (enriched_objects): item.obj_no -> "1.", "2."... item.subnums -> dict/obj com chaves (conforme o tipo): descricao methodology elements images weather_conditions road_conditions traffic_signage observed_elements item.obj -> ExamObject concreto item.images -> lista de ObjectImage já ordenada (index) cada img: img.image.url img.caption_html (opcional) img.figure_label -> "Figura 1", "Figura 2"... ─────────────────────────────────────────────────────────{% endcomment %}
        {% if exam_objects_ui %}
          <div class="list-group" id="examObjectsList" data-report-id="{{ report.pk }}" data-reorder-url="{% url 'report_maker:exam_objects_reorder' %}">
            {% for item in exam_objects_ui %}
              {% with obj=item.obj %}
                <div class="list-group-item d-flex align-items-start gap-2" data-id="{{ obj.pk }}" data-type="{{ item.type }}">
                  <div class="flex-grow-1">
                    <a href="{{ item.detail_url }}" class="text-decoration-none text-dark d-block">
                      <div class="fw-semibold">{{ item.display_title }}</div>

                      {% if obj.description %}
                        <div class="text-muted small">{{ obj.description|truncatechars:120 }}</div>
                      {% endif %}
                    </a>

                    {% if obj.images.exists %}
                      <div class="row g-2 mt-2">
                        {% for img in obj.images.all %}
                          <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                            <div class="card h-100 shadow-sm">
                              <a href="{{ img.image.url }}" target="_blank" rel="noopener" class="text-decoration-none"><img src="{{ img.image.url }}" class="card-img-top" alt="{{ img.caption|default:'Imagem' }}" style="height: 90px; object-fit: cover;" /></a>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>

                  {% if report.can_edit %}
                    <span class="text-muted small js-drag-handle" title="Arrastar para reordenar" style="cursor: grab; user-select:none;"><i class="bi bi-grip-vertical"></i></span>
                  {% endif %}
                </div>
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted small mb-0">Nenhum objeto de exame cadastrado.</p>
        {% endif %}
      </section>
    </main>
  </body>
</html>
