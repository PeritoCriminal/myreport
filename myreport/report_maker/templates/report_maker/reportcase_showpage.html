{# myreport/report_maker/templates/report_maker/reportcase_showpage.html #}

{% load static %}
{% load markdown_extras %}

<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Laudo nº {{ report.report_number }}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'report_maker/css/report_preview.css' %}" />
    <link rel="stylesheet" href="{% static 'report_maker/css/report_print.css' %}" />
  </head>

  <body>
    <button type="button" class="btn btn-light close-btn" data-action="close-preview">
      Fechar
    </button>

    <a href="{% url 'report_maker:report_pdf' report.pk %}" class="btn btn-light pdf-btn">
      PDF
    </a>

    <main class="report-stage">
      <section class="report-page">

        {# ───────────────────────── Cabeçalho institucional ───────────────────────── #}
        <header class="text-center">
          <table class="report-header" role="presentation">
            <tr>
              <td class="rh-img rh-left">
                {% if header.emblem_primary %}
                  <img src="{{ header.emblem_primary.url }}" alt="Emblema" class="rh-emblem" />
                {% endif %}
              </td>

              <td class="rh-center">
                <div class="rh-line rh-1">SECRETARIA DA SEGURANÇA PÚBLICA</div>

                {% if header.name or header.acronym %}
                  <div class="rh-line rh-2">
                    {{ header.name|default:'' }}
                    {% if header.acronym %}({{ header.acronym }}){% endif %}
                  </div>
                {% endif %}

                {% if header.kind_display %}
                  <div class="rh-line rh-3">{{ header.kind_display }}</div>
                {% endif %}

                {% if header.honoree_line %}
                  <div class="rh-line rh-4">"{{ header.honoree_line|upper }}"</div>
                {% endif %}

                {% if header.unit_line %}
                  <div class="rh-line rh-5">{{ header.unit_line }}</div>
                {% endif %}
              </td>

              <td class="rh-img rh-right">
                {% if header.emblem_secondary %}
                  <img src="{{ header.emblem_secondary.url }}" alt="Emblema" class="rh-emblem" />
                {% endif %}
              </td>
            </tr>
          </table>

          <div class="report-number">LAUDO Nº {{ report.report_number }}</div>
        </header>

        {# ───────────────────────── Preâmbulo ───────────────────────── #}
        {% if preamble %}
          <section class="report-section preamble">
            {{ preamble|linebreaks }}
          </section>
        {% endif %}

        {# ───────────────────────── Conteúdo estruturado (outline) ───────────────────────── #}
        {% if outline %}
          {% for g in outline %}

            {# Cabeçalho de grupo (apenas quando existir label) #}
            {% if g.number and g.group_label %}
              <section class="report-section group-block">
                <h2 class="section-heading">{{ g.number }} {{ g.group_label }}</h2>

                {% if g.intro_text %}
                  <div class="mb-3">{{ g.intro_text|linebreaks }}</div>
                {% endif %}
              </section>
            {% endif %}

            {# Objetos (inclui Resumo e Sumário como objetos virtuais) #}
            {% for o in g.objects %}
              <section class="report-section object-block">

                <h2 class="section-heading">
                  {{ o.number }} {{ o.title }}
                </h2>

                {% for s in o.sections %}
                  {% if s.number and s.label %}
                    <div class="object-subtitle">
                      {{ s.number }} {{ s.label }}
                    </div>
                  {% endif %}

                  {% if s.kind == "geo_location" %}
                    <div class="mb-2">
                      {% if s.maps_url %}
                        <div class="mb-2">
                          <span class="fw-semibold">Acesso via Google Maps:</span>
                          <a href="{{ s.maps_url }}" target="_blank" rel="noopener"
                             class="text-decoration-underline">
                            {{ s.maps_url }}
                          </a>
                        </div>
                      {% endif %}

                      {% if s.qr_data_uri %}
                        <div class="mt-2">
                          <img src="{{ s.qr_data_uri }}"
                               alt="QR Code Google Maps"
                               style="width: 120px; height: 120px;" />
                        </div>
                      {% endif %}
                    </div>

                    <div class="mb-2">
                      Coordenadas: {{ s.text|linebreaksbr }}
                    </div>

                  {% elif s.fmt == "kv" %}
                    <div class="mb-2">{{ s.text|linebreaksbr }}</div>
                  {% else %}
                    {{ s.text|render_markdown }}
                  {% endif %}
                {% endfor %}

                {# Figuras contínuas #}
                {% if o.images %}
                  <div class="figure-grid">
                    {% for it in o.images %}
                      <figure class="report-figure">
                        <img src="{{ it.img.image.url }}" alt="{{ it.figure_label }}" />
                        <figcaption>
                          {{ it.figure_label }}{% if it.img.caption %} — {{ it.img.caption }}{% endif %}
                        </figcaption>
                      </figure>
                    {% endfor %}
                  </div>
                {% endif %}
              </section>
            {% endfor %}
          {% endfor %}
        {% else %}
          <section class="report-section">
            <p class="text-muted small mb-0">Nenhum objeto de exame cadastrado.</p>
          </section>
        {% endif %}

        {# ───────────────────────── Conclusão (fora do outline) ───────────────────────── #}

        {% if final_considerations_blocks %}
          <section class="report-section">
            <h2 class="section-heading">{{ final_considerations_num }} Observações Finais</h2>

            {% for block in final_considerations_blocks %}
              <div class="mb-3">{{ block.body|render_markdown }}</div>
            {% endfor %}
          </section>
        {% endif %}


        {% if conclusion_blocks %}
          <section class="report-section">
            <h2 class="section-heading">{{ conclusion_num }} Conclusão</h2>

            {% for block in conclusion_blocks %}
              <div class="mb-3">{{ block.body|render_markdown }}</div>
            {% endfor %}
          </section>
        {% endif %}

      </section>
    </main>

    <script>
      document.addEventListener("click", (ev) => {
        const btn = ev.target.closest("[data-action='close-preview']")
        if (!btn) return
        window.close()
      })
    </script>
  </body>
</html>
