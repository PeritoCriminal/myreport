{# report_maker/templates/report_maker/image_editor_page.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}
  Editor de Imagem
{% endblock %}

{% block content %}
<div class="container my-4" style="max-width: 980px;">

  <div class="image-editor card shadow-sm" data-editor
       data-mode="{{ mode|default:'create' }}"
       {% if initial_image_url %}data-initial-image-url="{{ initial_image_url }}"{% endif %}>

    {# Barra superior #}
    <div class="card-header py-2">
      <div class="d-flex flex-wrap align-items-center gap-2">

        <div class="btn-group btn-group-sm" role="group" aria-label="Arquivo">
          <button type="button" class="btn btn-outline-secondary" data-action="pick_file" title="Selecionar imagem">
            <i class="bi bi-folder2-open"></i>
          </button>
        </div>

        <div class="btn-group btn-group-sm" role="group" aria-label="Zoom">
          <button type="button" class="btn btn-outline-secondary" data-action="zoom_out" title="Zoom -">
            <i class="bi bi-zoom-out"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary" data-action="zoom_reset" title="Reset zoom">
            <i class="bi bi-aspect-ratio"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary" data-action="zoom_in" title="Zoom +">
            <i class="bi bi-zoom-in"></i>
          </button>
        </div>

        <div class="btn-group btn-group-sm" role="group" aria-label="Rotação">
          <button type="button" class="btn btn-outline-secondary" data-action="rotate_left" title="Rotacionar -90°">
            <i class="bi bi-arrow-counterclockwise"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary" data-action="rotate_right" title="Rotacionar +90°">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>

        <div class="btn-group btn-group-sm" role="group" aria-label="Recorte">
          <button type="button" class="btn btn-outline-secondary" data-action="crop_start" title="Recortar">
            <i class="bi bi-crop"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary" data-action="crop_apply" title="Aplicar recorte">
            <i class="bi bi-check2"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary" data-action="crop_cancel" title="Cancelar recorte">
            <i class="bi bi-x"></i>
          </button>
        </div>

        <div class="btn-group btn-group-sm" role="group" aria-label="Blur">
          <button type="button" class="btn btn-outline-secondary" data-action="blur_toggle" title="Desfoque">
            <i class="bi bi-droplet-half"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary" data-action="blur_clear" title="Limpar desfoque">
            <i class="bi bi-eraser"></i>
          </button>
        </div>

        <div class="btn-group btn-group-sm ms-auto" role="group" aria-label="Ações gerais">
          <button type="button" class="btn btn-outline-secondary" data-action="reset_all" title="Resetar tudo">
            <i class="bi bi-arrow-repeat"></i>
          </button>
        </div>

      </div>
    </div>

    <div class="card-body">

      {# Input de arquivo oculto #}
      <div class="d-none" data-file-row>
        {{ form.image }}
      </div>

      {# Wrapper: escala + stage + legenda com a mesma largura #}
      <div class="mx-auto" data-stage-wrap style="width: 100%;">

        <div class="w-100" data-scale-wrap>
          {% include "report_maker/partials/scale14.html" %}
        </div>

        <div class="border rounded-3 bg-light w-100" data-stage style="overflow:hidden;">
          <canvas data-canvas style="display:block; width:100%;"></canvas>
        </div>

        <div class="form-text mt-2" data-hint>
          Use a barra superior para editar. Ao salvar, a imagem final será exportada do canvas.
        </div>

        <div class="mt-3 w-100" data-caption-wrap>
          <label class="form-label mb-1">Legenda</label>
          {{ form.caption }}
          {% if form.caption.errors %}
            <div class="text-danger small mt-1">{{ form.caption.errors }}</div>
          {% endif %}
        </div>

      </div>

    </div>

    <div class="card-footer d-flex gap-2 justify-content-end">
      <a href="{{ cancel_url }}" class="btn btn-outline-secondary btn-sm">Cancelar</a>
      <button type="submit" class="btn btn-primary btn-sm" data-action="save">
        <i class="bi bi-check-lg"></i> Salvar
      </button>
    </div>

  </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
  // Só para validar que está tudo carregando
  console.log("Editor carregado");

  const editor = document.querySelector("[data-editor]");
  if (!editor) return;

  const fileInput = editor.querySelector('[data-file-row] input[type="file"]');

  editor.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;

    const action = btn.dataset.action;

    if (action === "pick_file") {
      fileInput?.click();
      return;
    }
  });
</script>
{% endblock scripts %}
