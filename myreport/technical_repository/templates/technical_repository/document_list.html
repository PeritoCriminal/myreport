{% extends 'base.html' %}
{% load static %}

{% block title %}
  Arquivo Técnico
{% endblock %}

{% block content %}
  <div class="container mt-4" style="max-width: 980px;">
    <div class="d-flex justify-content-between align-items-center mb-3 gap-2">
      <h4 class="mb-0">Arquivo Técnico</h4>

      <a class="btn btn-primary" href="{% url 'technical_repository:document_create' %}">
        <i class="bi bi-plus-lg"></i>
        <span class="d-none d-md-inline">Novo arquivo</span>
      </a>
    </div>

    {% if documents %}
      {% regroup documents by topic as topic_list %}

      <div class="accordion" id="topicsAccordion">
        {% for group in topic_list %}
          {% with key=group.grouper.slug %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-{{ key }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ key }}" aria-expanded="false" aria-controls="collapse-{{ key }}">
                  {{ group.grouper.name }}
                  <span class="ms-2 text-muted small">({{ group.list|length }})</span>
                </button>
              </h2>

              <div id="collapse-{{ key }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ key }}">
                <div class="accordion-body p-0">
                  <div class="list-group list-group-flush">
                    {% for doc in group.list %}
                      <div class="list-group-item d-flex justify-content-between align-items-start gap-3">
                        {# Coluna esquerda (maior) #}
                        <div class="flex-grow-1 position-relative">
                          {# Link principal do item (ajuste para sua rota de detail se existir) #}
                          <a href="#" class="stretched-link text-decoration-none text-dark"></a>

                          <div class="fw-semibold">{{ doc.title }}</div>

                          {% if doc.description %}
                            <div class="text-muted small">{{ doc.description|truncatechars:200 }}</div>
                          {% endif %}

                          <div class="text-muted small mt-1">Por {{ doc.created_by }} · Atualizado em {{ doc.updated_at|date:'d/m/Y H:i' }}</div>
                        </div>

                        {# Coluna direita (menor): ícone PDF #}
                        <div class="flex-shrink-0">
                          {% if doc.current_versions and doc.current_versions.0 %}
                            {% with version=doc.current_versions.0 %}
                              <a href="{{ version.pdf_file.url }}" class="btn btn-sm btn-outline-danger d-inline-flex align-items-center" target="_blank" title="Baixar / exibir PDF"><i class="bi bi-file-earmark-pdf"></i></a>
                            {% endwith %}
                          {% else %}
                            <button class="btn btn-sm btn-outline-secondary" type="button" disabled data-bs-toggle="tooltip" data-bs-title="Sem PDF disponível"><i class="bi bi-file-earmark-pdf"></i></button>
                          {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-secondary">Nenhum documento técnico cadastrado.</div>
    {% endif %}
  </div>
{% endblock %}
