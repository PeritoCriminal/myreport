{% extends 'base.html' %}
{% load static %}

{% block title %}
  Arquivo Técnico
{% endblock %}

{# Os blocos 'extra_css' e 'scripts' foram removidos, pois o código personalizado não é mais necessário. #}

{% block content %}
  <div class="container mt-4" style="max-width: 980px;">
    <div class="d-flex justify-content-between align-items-center mb-3 gap-2">
      <h4 class="mb-0">Arquivo Técnico</h4>

      <a
        class="btn btn-primary"
        href="{% url 'technical_repository:document_create' %}"
        title="Novo arquivo técnico"
      >
        <i class="bi bi-plus-lg"></i>
        <span class="d-none d-md-inline">Novo arquivo</span>
      </a>
    </div>

    {% if documents %}
      {% regroup documents by topic as topic_list %}

      {# 1. Início do Accordion Bootstrap (usando accordion-flush para um estilo de lista) #}
      <div class="accordion accordion-flush border rounded-3" id="technicalRepositoryAccordion">
        {% for group in topic_list %}
          {# Cria um ID dinâmico e seguro para cada item do acordeão #}
          {% with accordion_id="topic-"|add:forloop.counter|stringformat:"d" %}
          <div class="accordion-item">
            {# 2. Cabeçalho do Tópico (Botão que expande/recolhe) #}
            <h2 class="accordion-header" id="{{ accordion_id }}-heading">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#{{ accordion_id }}-collapse"
                aria-expanded="false"
                aria-controls="{{ accordion_id }}-collapse"
              >
                <i class="bi bi-folder-fill me-2 text-primary"></i>
                {{ group.grouper.name }}
                <span class="badge text-bg-secondary ms-2">{{ group.list|length }}</span>
              </button>
            </h2>

            {# 3. Corpo do Tópico (Onde a lista de documentos será exibida) #}
            <div
              id="{{ accordion_id }}-collapse"
              class="accordion-collapse collapse"
              aria-labelledby="{{ accordion_id }}-heading"
              data-bs-parent="#technicalRepositoryAccordion"
            >
              <div class="accordion-body p-0">
                {# Lista de documentos dentro do tópico, usando list-group #}
                <ul class="list-group list-group-flush">
                  {% for doc in group.list %}
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                      <div class="me-auto pe-3">
                        <div class="fw-semibold text-break">{{ doc.title }}</div>
                        {% if doc.description %}
                          {# Trunca a descrição para manter a lista limpa #}
                          <small class="text-muted d-block mt-1">{{ doc.description|truncatechars:150 }}</small>
                        {% endif %}
                      </div>

                      {% with version=doc.current_versions.0 %}
                        {% if version %}
                          <a
                            href="{{ version.pdf_file.url }}"
                            class="btn btn-sm btn-outline-primary flex-shrink-0"
                            target="_blank"
                            title="Baixar PDF: {{ doc.title }}"
                          >
                            <i class="bi bi-file-earmark-pdf"></i>
                            <span class="d-none d-lg-inline ms-1">Baixar PDF</span>
                          </a>
                        {% else %}
                          <span class="badge text-bg-secondary flex-shrink-0">Sem PDF</span>
                        {% endif %}
                      {% endwith %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
      {# Fim do Accordion Bootstrap #}
    {% else %}
      <div class="alert alert-secondary mt-3">Nenhum documento técnico cadastrado.</div>
    {% endif %}
  </div>
{% endblock %}