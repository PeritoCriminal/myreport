{% extends "base.html" %}
{% load static %}

{% block content %}
  <div class="container mt-4" style="max-width: 820px;">
    <h2 class="mb-4">
      {% if object %}
        Editar grupo
      {% else %}
        Novo grupo
      {% endif %}
    </h2>

    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <!-- Nome -->
      <div class="mb-3">
        <label class="form-label">{{ form.name.label }}</label>
        {{ form.name }}
        {{ form.name.errors }}
      </div>

      <!-- Descrição -->
      {% if form.description %}
        <div class="mb-3">
          <label class="form-label">{{ form.description.label }}</label>
          {{ form.description }}
          {{ form.description.errors }}
        </div>
      {% endif %}

      <hr class="my-4" />

      <!-- Imagem de perfil -->
      {% if form.profile_image %}
        <div class="mb-3">
          <label class="form-label">{{ form.profile_image.label }}</label>

          <!-- Preview (circular) -->
          <div class="mt-2">
            <img
              id="profilePreview"
              class="rounded-circle border shadow-sm"
              style="width:120px; height:120px; object-fit:cover; display:none;"
              alt="Pré-visualização da imagem de perfil do grupo"
            />
          </div>

          {{ form.profile_image }}
          {{ form.profile_image.errors }}
        </div>

        <!-- Editor perfil -->
        <div id="profile-editor" class="img-editor-wrap mb-4" style="display:none;">
          <div class="card">
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                <strong>Ajuste da imagem de perfil</strong>
              </div>

              <div class="d-flex flex-column align-items-start gap-2">
                <canvas
                  id="profileCanvas"
                  width="420"
                  height="420"
                  style="width:100%; max-width:420px; border:1px solid rgba(255,255,255,.15); border-radius:50%; touch-action:none;">
                </canvas>

                <div class="d-flex justify-content-center gap-2 mt-2">
                  <button type="button" id="btnProfileZoomIn" class="btn btn-outline-secondary btn-sm">+</button>
                  <button type="button" id="btnProfileZoomOut" class="btn btn-outline-secondary btn-sm">−</button>
                  <button type="button" id="btnProfileCenter" class="btn btn-outline-secondary btn-sm">Centralizar</button>
                  <button type="button" id="btnProfileReset" class="btn btn-outline-secondary btn-sm">Reset</button>
                  <button type="button" id="btnProfileApply" class="btn btn-primary btn-sm">Aplicar</button>
                </div>

                <small class="text-muted">Pan: arrastar a imagem dentro do canvas.</small>
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Imagem de fundo -->
      {% if form.background_image %}
        <div class="mb-3">
          <label class="form-label">{{ form.background_image.label }}</label>
          {{ form.background_image }}
          {{ form.background_image.errors }}
        </div>

        <!-- Editor fundo -->
        <div id="bg-editor" class="img-editor-wrap mb-4" style="display:none;">
          <div class="card">
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                <strong>Ajuste da imagem de fundo</strong>
              </div>

              <div class="d-flex flex-column align-items-start gap-2">
                <canvas
                  id="bgCanvas"
                  width="1200"
                  height="400"
                  style="width:100%; border:1px solid rgba(255,255,255,.15); border-radius:.5rem; touch-action:none;">
                </canvas>

                <div class="d-flex justify-content-center gap-2 mt-2">
                  <button type="button" id="btnBgZoomIn" class="btn btn-outline-secondary btn-sm">+</button>
                  <button type="button" id="btnBgZoomOut" class="btn btn-outline-secondary btn-sm">−</button>
                  <button type="button" id="btnBgCenter" class="btn btn-outline-secondary btn-sm">Centralizar</button>
                  <button type="button" id="btnBgReset" class="btn btn-outline-secondary btn-sm">Reset</button>
                  <button type="button" id="btnBgApply" class="btn btn-primary btn-sm">Aplicar</button>
                </div>

                <small class="text-muted">Pan: arrastar a imagem dentro do canvas.</small>
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      <hr class="my-4" />

      <div class="d-flex gap-2 mt-4">
        <button class="btn btn-primary" type="submit">
          <i class="bi bi-check2"></i> {% if object %}Salvar{% else %}Criar{% endif %}
        </button>

        <a class="btn btn-link" href="{% url 'groups:group_list' %}">
          Cancelar
        </a>
      </div>
    </form>
  </div>

  <script>
    ;(function () {
      function clamp(v, a, b) {
        return Math.max(a, Math.min(b, v))
      }

      function dist(t1, t2) {
        const dx = t1.clientX - t2.clientX
        const dy = t1.clientY - t2.clientY
        return Math.hypot(dx, dy)
      }

      function createEditor(cfg) {
        const input = document.getElementById(cfg.inputId)
        const wrap = document.getElementById(cfg.wrapId)
        const canvas = document.getElementById(cfg.canvasId)
        const ctx = canvas.getContext('2d')

        const btnZoomIn = document.getElementById(cfg.btnZoomInId)
        const btnZoomOut = document.getElementById(cfg.btnZoomOutId)
        const btnCenter = document.getElementById(cfg.btnCenterId)
        const btnReset = document.getElementById(cfg.btnResetId)
        const btnApply = document.getElementById(cfg.btnApplyId)

        if (!input || !wrap || !canvas) return

        // Preview (somente para o perfil, se existir)
        const profilePreview = document.getElementById('profilePreview')

        let img = new Image()
        let loaded = false

        let scale = 1
        let minScale = 1
        const maxScale = cfg.maxScale ?? 6

        let ox = 0, oy = 0

        let dragging = false
        let startX = 0, startY = 0
        let startOX = 0, startOY = 0

        // pinch
        let pinching = false
        let pinchStartDist = 0
        let pinchStartScale = 1

        function fitToCanvas() {
          const sx = canvas.width / img.width
          const sy = canvas.height / img.height
          minScale = Math.max(sx, sy)
          scale = minScale

          const w = img.width * scale
          const h = img.height * scale

          ox = (canvas.width - w) / 2
          oy = (canvas.height - h) / 2
        }

        function bound() {
          const w = img.width * scale
          const h = img.height * scale

          const minX = canvas.width - w
          const minY = canvas.height - h

          if (w <= canvas.width) ox = (canvas.width - w) / 2
          else ox = clamp(ox, minX, 0)

          if (h <= canvas.height) oy = (canvas.height - h) / 2
          else oy = clamp(oy, minY, 0)
        }

        function draw() {
          if (!loaded) return

          ctx.clearRect(0, 0, canvas.width, canvas.height)
          ctx.imageSmoothingEnabled = true

          const w = img.width * scale
          const h = img.height * scale
          ctx.drawImage(img, ox, oy, w, h)

          // moldura
          ctx.save()
          ctx.strokeStyle = 'rgba(0,0,0,.35)'
          ctx.lineWidth = 2
          ctx.strokeRect(1, 1, canvas.width - 2, canvas.height - 2)
          ctx.restore()
        }

        function center() {
          if (!loaded) return
          const w = img.width * scale
          const h = img.height * scale
          ox = (canvas.width - w) / 2
          oy = (canvas.height - h) / 2
          bound()
          draw()
        }

        function reset() {
          if (!loaded) return
          fitToCanvas()
          bound()
          draw()
        }

        function zoomBy(factor, anchorX = canvas.width / 2, anchorY = canvas.height / 2) {
          if (!loaded) return

          const ix = (anchorX - ox) / scale
          const iy = (anchorY - oy) / scale

          const next = clamp(scale * factor, minScale, maxScale)
          if (next === scale) return

          scale = next
          ox = anchorX - ix * scale
          oy = anchorY - iy * scale

          bound()
          draw()
        }

        function loadFile(file) {
          const url = URL.createObjectURL(file)
          img = new Image()
          img.onload = () => {
            loaded = true
            wrap.style.display = 'block'
            fitToCanvas()
            bound()
            draw()
            URL.revokeObjectURL(url)
          }
          img.src = url
        }

        input.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0]
          if (!file) return

          // Preview circular (perfil)
          if (profilePreview && cfg.inputId === cfg.profileInputIdForPreview) {
            profilePreview.src = URL.createObjectURL(file)
            profilePreview.style.display = 'block'
          }

          loadFile(file)
        })

        // zoom no wheel / trackpad (desktop)
        canvas.addEventListener(
          'wheel',
          (e) => {
            if (!loaded) return
            e.preventDefault()
            const rect = canvas.getBoundingClientRect()
            const ax = ((e.clientX - rect.left) / rect.width) * canvas.width
            const ay = ((e.clientY - rect.top) / rect.height) * canvas.height
            const factor = e.deltaY < 0 ? cfg.zoomStep ?? 1.12 : 1 / (cfg.zoomStep ?? 1.12)
            zoomBy(factor, ax, ay)
          },
          { passive: false }
        )

        // pan (mouse)
        canvas.addEventListener('mousedown', (e) => {
          if (!loaded) return
          dragging = true
          startX = e.clientX
          startY = e.clientY
          startOX = ox
          startOY = oy
          e.preventDefault()
        })

        window.addEventListener('mousemove', (e) => {
          if (!dragging) return
          ox = startOX + (e.clientX - startX)
          oy = startOY + (e.clientY - startY)
          bound()
          draw()
        })

        window.addEventListener('mouseup', () => {
          dragging = false
        })

        // touch: pan + pinch
        canvas.addEventListener(
          'touchstart',
          (e) => {
            if (!loaded) return

            if (e.touches.length === 1) {
              dragging = true
              pinching = false
              startX = e.touches[0].clientX
              startY = e.touches[0].clientY
              startOX = ox
              startOY = oy
              e.preventDefault()
              return
            }

            if (e.touches.length === 2) {
              dragging = false
              pinching = true
              pinchStartDist = dist(e.touches[0], e.touches[1])
              pinchStartScale = scale
              e.preventDefault()
            }
          },
          { passive: false }
        )

        canvas.addEventListener(
          'touchmove',
          (e) => {
            if (!loaded) return

            if (dragging && e.touches.length === 1) {
              ox = startOX + (e.touches[0].clientX - startX)
              oy = startOY + (e.touches[0].clientY - startY)
              bound()
              draw()
              e.preventDefault()
              return
            }

            if (pinching && e.touches.length === 2) {
              const d = dist(e.touches[0], e.touches[1])
              if (!pinchStartDist) return

              const factor = d / pinchStartDist
              const next = clamp(pinchStartScale * factor, minScale, maxScale)
              if (next === scale) return

              const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2
              const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2
              const rect = canvas.getBoundingClientRect()
              const ax = ((cx - rect.left) / rect.width) * canvas.width
              const ay = ((cy - rect.top) / rect.height) * canvas.height

              const rel = next / scale
              zoomBy(rel, ax, ay)

              e.preventDefault()
            }
          },
          { passive: false }
        )

        canvas.addEventListener(
          'touchend',
          () => {
            dragging = false
            pinching = false
            pinchStartDist = 0
          },
          { passive: false }
        )

        // botões
        btnZoomIn && btnZoomIn.addEventListener('click', () => zoomBy(cfg.zoomStep ?? 1.12))
        btnZoomOut && btnZoomOut.addEventListener('click', () => zoomBy(1 / (cfg.zoomStep ?? 1.12)))
        btnCenter && btnCenter.addEventListener('click', center)
        btnReset && btnReset.addEventListener('click', reset)

        btnApply &&
          btnApply.addEventListener('click', async () => {
            if (!loaded) return

            const blob = await new Promise((resolve) =>
              canvas.toBlob(resolve, cfg.mimeType ?? 'image/jpeg', cfg.quality ?? 0.9)
            )
            if (!blob) return

            const originalName =
              input.files && input.files[0] && input.files[0].name
                ? input.files[0].name
                : cfg.defaultName ?? 'image.jpg'

            const base = originalName.replace(/\.[^/.]+$/, '')
            const finalName =
              (cfg.suffix ? base + cfg.suffix : base + '_crop') + (cfg.ext ?? '.jpg')

            const newFile = new File([blob], finalName, { type: blob.type })
            const dt = new DataTransfer()
            dt.items.add(newFile)
            input.files = dt.files
          })
      }

      // Ajuste os IDs para os IDs reais dos fields do seu GroupForm:
      // por padrão Django: id_profile_image / id_background_image
      createEditor({
        inputId: 'id_profile_image',
        profileInputIdForPreview: 'id_profile_image',
        wrapId: 'profile-editor',
        canvasId: 'profileCanvas',
        btnZoomInId: 'btnProfileZoomIn',
        btnZoomOutId: 'btnProfileZoomOut',
        btnCenterId: 'btnProfileCenter',
        btnResetId: 'btnProfileReset',
        btnApplyId: 'btnProfileApply',
        defaultName: 'profile.jpg',
        suffix: '_profile',
        ext: '.jpg',
        zoomStep: 1.12,
        maxScale: 6
      })

      createEditor({
        inputId: 'id_background_image',
        wrapId: 'bg-editor',
        canvasId: 'bgCanvas',
        btnZoomInId: 'btnBgZoomIn',
        btnZoomOutId: 'btnBgZoomOut',
        btnCenterId: 'btnBgCenter',
        btnResetId: 'btnBgReset',
        btnApplyId: 'btnBgApply',
        defaultName: 'background.jpg',
        suffix: '_bg',
        ext: '.jpg',
        zoomStep: 1.12,
        maxScale: 6
      })
    })()
  </script>
{% endblock %}
